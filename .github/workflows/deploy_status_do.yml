name: StoryForge deploy status → in-app bar

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: "Why this was triggered"
        required: false
        default: "manual"

concurrency:
  group: storyforge-deploy-status-main
  cancel-in-progress: false

jobs:
  deploy_status:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      STORYFORGE_URL: https://storyforge.i0q.com
      DO_APP_ID: 11f8a3b9-7dda-4890-b1c7-b459aa050c2b

    steps:
      - name: Mark deploy started (StoryForge)
        env:
          SF_DEPLOY_TOKEN: ${{ secrets.SF_DEPLOY_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${SF_DEPLOY_TOKEN:-}" ]; then
            echo "Missing secrets.SF_DEPLOY_TOKEN" >&2
            exit 1
          fi
          curl -fsS -X POST "$STORYFORGE_URL/api/deploy/start" \
            -H "content-type: application/json" \
            -H "x-sf-deploy-token: $SF_DEPLOY_TOKEN" \
            -d '{"message":"Deploying (GitHub push '"${GITHUB_SHA:0:7}"'")}'

      - name: Trigger DigitalOcean App Platform deployment
        id: do_trigger
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${DIGITALOCEAN_TOKEN:-}" ]; then
            echo "Missing secrets.DIGITALOCEAN_TOKEN" >&2
            exit 1
          fi

          api="https://api.digitalocean.com/v2/apps/$DO_APP_ID/deployments"
          auth=(-H "Authorization: Bearer $DIGITALOCEAN_TOKEN" -H "Content-Type: application/json")

          echo "Triggering deployment via DO API…"
          resp=$(curl -fsS -X POST "${auth[@]}" "$api" -d '{}')
          dep_id=$(echo "$resp" | jq -r '.deployment.id // .deployment.deployment_id // .id // empty')
          if [ -z "$dep_id" ]; then
            echo "Could not parse deployment id from response" >&2
            echo "$resp" >&2
            exit 2
          fi
          echo "deployment_id=$dep_id" >> "$GITHUB_OUTPUT"
          echo "Triggered deployment id: $dep_id"

      - name: Wait for DigitalOcean App Platform deployment to finish
        id: wait_do
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${DIGITALOCEAN_TOKEN:-}" ]; then
            echo "Missing secrets.DIGITALOCEAN_TOKEN" >&2
            exit 1
          fi

          api="https://api.digitalocean.com/v2/apps/$DO_APP_ID/deployments"
          auth=(-H "Authorization: Bearer $DIGITALOCEAN_TOKEN" -H "Content-Type: application/json")
          dep_id="${{ steps.do_trigger.outputs.deployment_id }}"

          echo "Polling DO deployment $dep_id…"
          phase=""
          for i in $(seq 1 360); do
            j=$(curl -fsS "${auth[@]}" "$api?per_page=20")
            phase=$(echo "$j" | jq -r --arg id "$dep_id" '.deployments[] | select(.id==$id) | (.phase // .status // .progress.phase // "")')
            created=$(echo "$j" | jq -r --arg id "$dep_id" '.deployments[] | select(.id==$id) | (.created_at // "")')
            echo "[$i] phase=$phase created_at=$created"

            case "$phase" in
              ACTIVE|SUCCEEDED|SUCCESS|COMPLETED)
                echo "Deployment completed successfully."
                echo "result=success" >> "$GITHUB_OUTPUT"
                exit 0
                ;;
              ERROR|FAILED|CANCELED|CANCELLED)
                echo "Deployment failed: phase=$phase" >&2
                echo "result=failure" >> "$GITHUB_OUTPUT"
                exit 3
                ;;
              "")
                ;;
              *)
                ;;
            esac
            sleep 5
          done

          echo "Timed out waiting for deployment to finish" >&2
          echo "result=timeout" >> "$GITHUB_OUTPUT"
          exit 4

      - name: Mark deploy ended (StoryForge)
        if: always()
        env:
          SF_DEPLOY_TOKEN: ${{ secrets.SF_DEPLOY_TOKEN }}
        run: |
          set -euo pipefail
          res="${{ steps.wait_do.outputs.result || 'unknown' }}"
          msg="Deployed"
          if [ "$res" = "success" ]; then msg="Deployed"; fi
          if [ "$res" = "failure" ]; then msg="Deploy failed"; fi
          if [ "$res" = "timeout" ]; then msg="Deploy timed out"; fi
          curl -fsS -X POST "$STORYFORGE_URL/api/deploy/end" \
            -H "content-type: application/json" \
            -H "x-sf-deploy-token: $SF_DEPLOY_TOKEN" \
            -d '{"message":"'"$msg"' (GitHub push '"${GITHUB_SHA:0:7}"'")}' || true
