name: StoryForge deploy status → in-app bar

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: "Why this was triggered"
        required: false
        default: "manual"

concurrency:
  group: storyforge-deploy-status-main
  cancel-in-progress: false

jobs:
  deploy_status:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      STORYFORGE_URL: https://storyforge.i0q.com
      DO_APP_ID: 11f8a3b9-7dda-4890-b1c7-b459aa050c2b

    steps:
      - name: Mark deploy started (StoryForge)
        env:
          SF_DEPLOY_TOKEN: ${{ secrets.SF_DEPLOY_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${SF_DEPLOY_TOKEN:-}" ]; then
            echo "Missing secrets.SF_DEPLOY_TOKEN" >&2
            exit 1
          fi
          msg="Deploying (Commit ${GITHUB_SHA:0:7})"
          payload=$(jq -nc --arg m "$msg" --arg c "${GITHUB_SHA:0:7}" '{message:$m,commit:$c}')
          curl -fsS -X POST "$STORYFORGE_URL/api/deploy/start" \
            -H "content-type: application/json" \
            -H "x-sf-deploy-token: $SF_DEPLOY_TOKEN" \
            -d "$payload"

      - name: Wait for DigitalOcean App Platform deployment for this commit to finish
        id: wait_do
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${DIGITALOCEAN_TOKEN:-}" ]; then
            echo "Missing secrets.DIGITALOCEAN_TOKEN" >&2
            exit 1
          fi

          api="https://api.digitalocean.com/v2/apps/$DO_APP_ID/deployments"
          auth=(-H "Authorization: Bearer $DIGITALOCEAN_TOKEN" -H "Content-Type: application/json")
          sha="$GITHUB_SHA"

          echo "Polling DO deployments for commit ${sha:0:7}…"

          mode="commit"   # commit|follow
          commit_id=""
          commit_created=""
          dep_id=""

          # 10 minute timeout (120 * 5s)
          for i in $(seq 1 120); do
            j=$(curl -fsS "${auth[@]}" "$api?per_page=20")

            if [ "$mode" = "commit" ]; then
              # Find the deployment triggered by this commit
              dep_id=$(echo "$j" | jq -r --arg s "${sha:0:7}" '.deployments[] | select((.cause // "") | contains($s)) | .id' | head -n 1)
              if [ -z "$dep_id" ]; then
                echo "[$i] no deployment found yet for commit ${sha:0:7}; waiting…"
                sleep 5
                continue
              fi
              if [ -z "$commit_id" ]; then
                commit_id="$dep_id"
                commit_created=$(echo "$j" | jq -r --arg id "$dep_id" '.deployments[] | select(.id==$id) | (.created_at // "")')
              fi
            else
              # Follow the newest deployment created after (or at) the commit deployment.
              dep_id=$(echo "$j" | jq -r --arg t "$commit_created" --arg cid "$commit_id" '
                .deployments[]
                | select((.created_at // "") >= $t)
                | select(.id != $cid)
                | .id
              ' | head -n 1)
              if [ -z "$dep_id" ]; then
                # If no newer deployment is visible yet, keep watching the commit deployment id.
                dep_id="$commit_id"
              fi
            fi

            phase=$(echo "$j" | jq -r --arg id "$dep_id" '.deployments[] | select(.id==$id) | (.phase // .status // .progress.phase // "")')
            created=$(echo "$j" | jq -r --arg id "$dep_id" '.deployments[] | select(.id==$id) | (.created_at // "")')
            cause=$(echo "$j" | jq -r --arg id "$dep_id" '.deployments[] | select(.id==$id) | (.cause // "")')

            echo "[$i] mode=$mode id=$dep_id phase=$phase created_at=$created cause=$cause"

            case "$phase" in
              ACTIVE|SUCCEEDED|SUCCESS|COMPLETED)
                echo "Deployment completed successfully."
                echo "result=success" >> "$GITHUB_OUTPUT"
                exit 0
                ;;
              ERROR|FAILED)
                echo "Deployment failed: phase=$phase" >&2
                echo "result=failure" >> "$GITHUB_OUTPUT"
                exit 3
                ;;
              SUPERSEDED|CANCELED|CANCELLED)
                if [ "$mode" = "commit" ]; then
                  echo "Commit deployment ended early ($phase). Following the next deployment to completion…" >&2
                  mode="follow"
                else
                  # A followed deployment was superseded/canceled; keep following.
                  echo "Followed deployment ended early ($phase). Continuing to follow newest deployment…" >&2
                fi
                ;;
              "")
                ;;
              *)
                ;;
            esac
            sleep 5
          done

          echo "Timed out waiting for deployment to finish" >&2
          echo "result=timeout" >> "$GITHUB_OUTPUT"
          exit 4

      - name: Mark deploy ended (StoryForge)
        if: always()
        env:
          SF_DEPLOY_TOKEN: ${{ secrets.SF_DEPLOY_TOKEN }}
        run: |
          set -euo pipefail
          res="${{ steps.wait_do.outputs.result || 'unknown' }}"
          msg="Deployed"
          if [ "$res" = "success" ]; then msg="Deployed"; fi
          if [ "$res" = "failure" ]; then msg="Deploy failed"; fi
          if [ "$res" = "timeout" ]; then msg="Deploy timed out"; fi
          if [ "$res" = "superseded" ]; then msg="Deploy superseded"; fi
          msg2="$msg (Commit ${GITHUB_SHA:0:7})"
          payload=$(jq -nc --arg m "$msg2" --arg c "${GITHUB_SHA:0:7}" '{message:$m,commit:$c}')
          curl -fsS -X POST "$STORYFORGE_URL/api/deploy/end" \
            -H "content-type: application/json" \
            -H "x-sf-deploy-token: $SF_DEPLOY_TOKEN" \
            -d "$payload" || true
