<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Storyforge Monitor</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding:16px;}
    a{color:#0b63ce;}
    .job{padding:12px; border:1px solid #ddd; border-radius:12px; margin:12px 0;}
    .cardrow{display:flex; justify-content:space-between; align-items:flex-start; gap:12px;}
    .left{flex:1; min-width:0;}
    .right{display:flex; flex-direction:row; gap:8px; align-items:center;}
    .btn{display:inline-block; padding:8px 10px; border-radius:10px; border:1px solid #d1d5db; text-decoration:none; font-weight:700; font-size:13px; min-width:0; text-align:center;}
    .btn.primary{background:#0b63ce; color:#fff; border-color:#0b63ce;}
    .btn.secondary{background:#fff; color:#0b63ce;}
    .muted{color:#666; font-size: 12px;}
  .row{display:flex; justify-content:space-between; align-items:center; gap:10px;}
  .badge{font-size:10px; font-weight:750; padding:4px 8px; border-radius:999px; border:1px solid #ddd; text-transform:uppercase; letter-spacing:0.02em; white-space:nowrap;}
  .badge.running{background:#e0f2fe; border-color:#38bdf8; color:#075985;}
  .badge.completed{background:#dcfce7; border-color:#22c55e; color:#14532d;}
  .badge.aborted{background:#fee2e2; border-color:#ef4444; color:#7f1d1d;}
  .badge.pending{background:#f3f4f6; border-color:#d1d5db; color:#374151;}
  .dl{font-size:12px; margin-top:6px;}
  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
  .btn{display:inline-block; padding:12px 14px; border-radius:12px; border:1px solid #d1d5db; text-decoration:none; font-weight:700; font-size:15px;}
  .btn.primary{background:#0b63ce; color:#fff; border-color:#0b63ce;}
  .btn.secondary{background:#fff; color:#0b63ce;}
  </style>
</head>
<body>
  <h2>Storyforge Monitor</h2>
  <div id="jobs">Loading…</div>

<script>
const params = new URLSearchParams(location.search);
const t = params.get('t');
async function refresh(){
  const r = await fetch('/api/jobs?t='+encodeURIComponent(t));
  const j = await r.json();
  const el = document.getElementById('jobs');
  if(!j.ok){ el.textContent = 'Error'; return; }
  if(j.jobs.length===0){ el.textContent = 'No jobs yet.'; return; }
  el.innerHTML = '';
  for(const job of j.jobs){
    const div = document.createElement('div');
    div.className='job';
    const started = job.started_at ? new Date(job.started_at*1000).toLocaleString() : '';
    div.innerHTML =
      '<div class="cardrow">'
        + '<div class="left">'
          + '<div class="row">'
            + '<b>' + (job.title||job.id) + '</b>'
            + '<span class="badge ' + ((job.status&&job.status.state)||'unknown') + '">' + ((job.status&&job.status.state)||'unknown') + '</span>'
          + '</div>'
          + '<div class="muted">' + started + ' — ' + (job.sfml||'') + '</div>'
        + '</div>'
        + '<div class="right">'
          + '<a class="btn primary" href="/job/' + job.id + '?t=' + encodeURIComponent(t) + '">Open</a>'
          + (((job.mp3) && (job.status) && (job.status.state==="completed"))
              ? ('<a class="btn secondary" href="/dl/' + job.id + '?t=' + encodeURIComponent(t) + '">Audio</a>')
              : '')
        + '</div>'
      + '</div>';

    el.appendChild(div);
  }
}
refresh();
setInterval(refresh, 3000);
</script>
</body>
</html>
