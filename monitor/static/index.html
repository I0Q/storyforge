<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Storyforge Monitor</title>
  
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding:16px;}
    a{color:#0b63ce;}
    h1{margin:0 0 6px;}
    h2{margin:0 0 10px;}
    pre{white-space:pre-wrap; background:#111; color:#ddd; padding:12px; border-radius:10px;}
    .muted{color:#666; font-size:12px;}

    .badge{font-size:12px; font-weight:850; padding:6px 10px; border-radius:999px; border:1px solid #ddd; text-transform:uppercase; letter-spacing:0.02em;}
    .badge.running{background:#e0f2fe; border-color:#38bdf8; color:#075985;}
    .badge.completed{background:#dcfce7; border-color:#22c55e; color:#14532d;}
    .badge.aborted{background:#fee2e2; border-color:#ef4444; color:#7f1d1d;}
    .badge.pending{background:#f3f4f6; border-color:#d1d5db; color:#374151;}
    .badge.unknown{background:#f3f4f6; border-color:#d1d5db; color:#374151;}

    .btn{display:inline-block; padding:10px 12px; border-radius:10px; border:1px solid #d1d5db; text-decoration:none; font-weight:800; font-size:14px; background:#fff;}
    .btn.tiny{padding:6px 10px; font-size:12px; border-radius:999px;}
    .btnrow{display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap;}

    .card{border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fff;}
    .cardTop{display:flex; justify-content:space-between; gap:12px; align-items:flex-start;}
    .title{font-weight:950; font-size:16px;}

    .prog{display:flex; align-items:center; gap:10px; margin:10px 0 6px;}
    .pbar{flex:1; height:16px; background:#eee; border-radius:999px; overflow:hidden; position:relative;}
    .pfill{height:16px; background:#0b63ce; width:0%;}
    .ptext{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:900; color:#111;}

    .pillrow{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;}
    .pill{font-size:12px; background:#f3f4f6; border-radius:999px; padding:4px 8px; font-weight:700;}

    .row{border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px; margin:10px 0; display:flex; justify-content:space-between; gap:10px; align-items:center; background:#fff; cursor:pointer;}
    .rowTop{display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .rowMain{flex:1; min-width:0;}
    .rowTitle{font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .rowBtns{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    details{border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px; margin:10px 0 0;}
    summary{cursor:pointer; font-weight:800;}
  </style>

</head>
<body>

  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
  <h1>Storyforge Monitor</h1>
  <div class="btnrow">
    <a class="btn tiny" id="voicesBtn" href="#">Voices</a>
  </div>
</div>

  <div id="runningWrap">
    <h2 style="margin-top:18px;">Running</h2>
    <div class="card" id="noRun">
      <div class="title">No job running</div>
      <div class="muted">When you start a render, it will appear here with progress + log tail.</div>
    </div>
    <div class="card" id="runCard" style="display:none;">
      <div class="cardTop">
        <div>
          <div class="title" id="runTitle">—</div>
          <div class="muted" id="runMeta">—</div>
        </div>
        <div class="btnrow">
          <a class="btn tiny" id="runOpen" href="#">Open</a>
          <a class="btn tiny" id="runSfml" href="#" target="_blank" rel="noopener">SFML</a>
          <a class="btn tiny" id="runAudio" href="#" target="_blank" rel="noopener">AUDIO</a>
        </div>
      </div>

      <div class="prog">
        <div class="pbar"><div class="pfill" id="runFill"></div><div class="ptext" id="runText">—</div></div>
      </div>
      <div class="pillrow" id="runPills"></div>

      <details open>
        <summary>Log tail</summary>
        <pre id="runLog">(loading…)</pre>
      </details>
    </div>
  </div>

  <h2 style="margin-top:18px;">History</h2>
  <div class="muted" style="margin-bottom:8px;">Most recent first. Use OPEN for details.</div>
  <div id="hist"><div class="muted">(loading…)</div></div>

  <script>
  (function(){
    window.onerror = function(msg, src, line, col){
      var el = document.getElementById('hist');
      if(el){ el.innerHTML = '<div class="muted">JS error: ' + String(msg) + ' @ ' + String(line||'?') + ':' + String(col||'?') + '</div>'; }
      return false;
    };

    function getParam(name){
      var q=location.search||'';
      if(q.charAt(0)==='?') q=q.slice(1);
      var parts=q.split('&');
      for(var i=0;i<parts.length;i++){
        var kv=parts[i].split('=');
        if(decodeURIComponent(kv[0]||'')===name) return decodeURIComponent(kv.slice(1).join('=')||'');
      }
      return '';
    }

    var t = getParam('t') || '';

    var vb = document.getElementById('voicesBtn');
    if(vb){ vb.href = '/voices?t=' + encodeURIComponent(t); }

    function esc(s){
      s = (s===null||s===undefined) ? '' : String(s);
      return s.replace(/[&<>"']/g, function(c){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',''':'&#39;'}[c]) || c;
      });
    }

    function fmtTs(ts){
      if(!ts) return '-';
      try { return new Date(ts*1000).toLocaleString(); } catch(e){ return String(ts); }
    }

    function fmtElapsed(sec){
      if(sec===null || sec===undefined) return '-';
      sec = Math.max(0, Math.floor(sec));
      var h=Math.floor(sec/3600);
      var m=Math.floor((sec%3600)/60);
      var s=sec%60;
      function p2(x){ return (x<10?'0':'')+String(x); }
      if(h>0) return String(h)+':' + p2(m) + ':' + p2(s);
      return String(m)+':' + p2(s);
    }

    function badge(state){
      var st = state || 'unknown';
      return '<span class="badge ' + esc(st) + '">' + esc(st) + '</span>';
    }

    function getJson(url, cb){
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.timeout = 8000;
      xhr.onerror = function(){ cb(new Error('network error'), null); };
      xhr.ontimeout = function(){ cb(new Error('timeout'), null); };
      xhr.onreadystatechange = function(){
        if(xhr.readyState !== 4) return;
        if(xhr.status < 200 || xhr.status >= 300){
          cb(new Error('HTTP ' + xhr.status), null);
          return;
        }
        try { cb(null, JSON.parse(xhr.responseText)); }
        catch(e){ cb(e, null); }
      };
      xhr.send();
    }

    function setRunningNone(){
      var noRun = document.getElementById('noRun');
      var card = document.getElementById('runCard');
      if(noRun) noRun.style.display='block';
      if(card) card.style.display='none';
    }

    function setRunning(job){
      var noRun = document.getElementById('noRun');
      var card = document.getElementById('runCard');
      if(noRun) noRun.style.display='none';
      if(card) card.style.display='block';

      document.getElementById('runTitle').textContent = job.title || job.id;
      document.getElementById('runMeta').textContent = fmtTs(job.started_at) + (job.sfml ? ('  ' + job.sfml) : '');
      document.getElementById('runOpen').href = '/job/' + encodeURIComponent(job.id) + '?t=' + encodeURIComponent(t);
      document.getElementById('runSfml').href = '/view/' + encodeURIComponent(job.id) + '?t=' + encodeURIComponent(t);
    }

    function renderHistory(jobs){
      var el = document.getElementById('hist');
      if(!jobs || !jobs.length){ el.innerHTML = '<div class="muted">No jobs yet.</div>'; return; }

      var out = [];
      for(var i=0;i<jobs.length;i++){
        var j = jobs[i];
        var st = (j.status && j.status.state) ? j.status.state : (j.state||'unknown');
        var done = (j.progress && (j.progress.done!==undefined)) ? j.progress.done : (j.segments_done!==null && j.segments_done!==undefined ? j.segments_done : null);
        var total = (j.progress && (j.progress.total!==undefined)) ? j.progress.total : (j.total_segments||null);
        var finished_at = j.finished_at || (j.status ? j.status.finished_at : null);
        var elapsed = (j.started_at && finished_at) ? (finished_at - j.started_at) : null;

        var openBtn = '<a class="btn tiny" href="/job/' + encodeURIComponent(j.id) + '?t=' + encodeURIComponent(t) + '">OPEN</a>';
        var sfmlBtn = '<a class="btn tiny" href="/sfml/' + encodeURIComponent(j.id) + '?t=' + encodeURIComponent(t) + '" target="_blank" rel="noopener">SFML</a>';
        var audioBtn = (j.mp3 && st==='completed') ? ('<a class="btn tiny" href="/dl/' + encodeURIComponent(j.id) + '?t=' + encodeURIComponent(t) + '" target="_blank" rel="noopener">AUDIO</a>') : '';

        out.push(
          '<div class="row">' +
            '<div class="rowMain">' +
              '<div class="rowTop">' +
                '<div class="rowTitle">' + esc(j.title||j.id) + '</div>' +
                '<div>' + badge(st) + '</div>' +
              '</div>' +
              '<div class="muted">' + esc(fmtTs(j.started_at)) + '  ' + (done===null||total===null?'-':(done + '/' + total)) + ' seg  ' + esc(fmtElapsed(elapsed)) + '</div>' +
            '</div>' +
            '<div class="rowBtns">' + openBtn + sfmlBtn + audioBtn + '</div>' +
          '</div>'
        );
      }
      el.innerHTML = out.join('
');
    }

    function refresh(){
      var histEl = document.getElementById('hist');
      if(histEl) histEl.innerHTML = '<div class="muted">(loading...)</div>';

      getJson('/api/jobs?t=' + encodeURIComponent(t), function(err, data){
        if(err || !data || !data.ok){
          if(histEl) histEl.innerHTML = '<div class="muted">Failed to load: ' + esc(err?err.message:'bad response') + '</div>';
          return;
        }

        var jobs = data.jobs || [];
        var running = null;
        for(var i=0;i<jobs.length;i++){
          var st = (jobs[i].status && jobs[i].status.state) ? jobs[i].status.state : jobs[i].state;
          if(st === 'running'){ running = jobs[i]; break; }
        }

        if(!running){
          setRunningNone();
        } else {
          setRunning(running);
          getJson('/api/job/' + encodeURIComponent(running.id) + '?t=' + encodeURIComponent(t), function(err2, j2){
            if(!err2 && j2 && j2.ok){
              var done = (j2.status && (j2.status.done!==undefined)) ? j2.status.done : 0;
              var total = (j2.status && (j2.status.total!==undefined)) ? j2.status.total : (running.total_segments||0);
              var pct = (total>0) ? Math.max(0, Math.min(100, (done/total)*100.0)) : 0;
              var fill = document.getElementById('runFill');
              if(fill) fill.style.width = String(pct) + '%';
              var rt = document.getElementById('runText');
              if(rt) rt.textContent = total ? (done + '/' + total + ' segments') : (done + ' segments');
              var log = document.getElementById('runLog');
              if(log) log.textContent = (j2.log_tail && j2.log_tail.length) ? j2.log_tail.join('
') : '(no log yet)';
              var pills = document.getElementById('runPills');
              var nowTs = j2.now;
              var startedAt = (j2.job && j2.job.started_at) ? j2.job.started_at : null;
              var elapsed = (startedAt && nowTs) ? (nowTs - startedAt) : null;
              var st2 = (j2.status && j2.status.state) ? j2.status.state : 'running';
              if(pills){
                pills.innerHTML = '<div class="pill">Time: ' + esc(fmtElapsed(elapsed)) + '</div>' +
                                  '<div class="pill">Status: ' + esc(st2) + '</div>';
              }
              var a = document.getElementById('runAudio');
              if(a){
                if(j2.mp3 && st2==='completed'){
                  a.style.display='inline-block';
                  a.href='/dl/' + encodeURIComponent(running.id) + '?t=' + encodeURIComponent(t);
                } else {
                  a.style.display='none';
                }
              }
            }
          });
        }

        var hist = [];
        for(var k=0;k<jobs.length;k++){
          if(running && jobs[k].id === running.id) continue;
          hist.push(jobs[k]);
        }
        renderHistory(hist);
      });
    }

    refresh();
    setInterval(refresh, 5000);
  })();
  </script>

<!-- Bottom sheet: system monitor -->
<style>
  .bs{position:fixed; left:0; right:0; bottom:0; z-index:9999; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
  .bs .handle{margin:0 auto; width:46px; height:5px; background:#d1d5db; border-radius:999px;}
  .bs .bar{background:rgba(255,255,255,.96); border-top:1px solid #e5e7eb; box-shadow:0 -10px 25px rgba(0,0,0,.08); padding:10px 14px;}
  .bs .barTop{display:flex; justify-content:space-between; align-items:center; gap:10px;}
  .bs .title{font-weight:900; font-size:13px;}
  .bs .mini{font-size:12px; color:#666;}
  .bs .btn{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #d1d5db; text-decoration:none; font-weight:800; font-size:12px; color:#0b63ce; background:#fff;}
  .bs .panel{display:none; padding-top:10px;}
  .bs.open .panel{display:block;}
  .bs .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-top:10px;}
  .bs .g{border:1px solid #ddd; border-radius:12px; padding:10px 12px; background:#fff;}
  .bs .ghead{display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px;}
  .bs .gt{font-weight:850;}
  .bs .gsub{font-size:12px; color:#666; white-space:nowrap;}
  .bs .metric{display:flex; align-items:center; gap:8px; margin:6px 0;}
  .bs .label{width:42px; font-size:12px; color:#666;}
  .bs .ibar{flex:1; height:8px; background:#f1f1f1; border-radius:999px; overflow:hidden;}
  .bs .ifill{height:8px; width:0%;}
  .bs .ifill.green{background:#1f9d55;}
  .bs .ifill.amber{background:#d97706;}
  .bs .ifill.red{background:#dc2626;}
  .bs .val{min-width:64px; text-align:right; font-variant-numeric:tabular-nums; font-size:12px; font-weight:700;}
  .bs details{border:1px solid #ddd; border-radius:12px; padding:10px 12px; margin-top:10px; background:#fff;}
  .bs summary{cursor:pointer; font-weight:750;}
  .bs .plist{margin-top:8px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:11px; color:#333; white-space:pre; overflow-x:auto;}
  body{padding-bottom:90px;} /* room for bar */
</style>

<div id="bottomSheet" class="bs">
  <div class="bar">
    <div class="handle" aria-hidden="true"></div>
    <div class="barTop" style="margin-top:8px;">
      <div>
        <div class="title">System Monitor</div>
        <div class="mini" id="bsMini">Loading…</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <a href="#" id="bsToggle" class="btn">Show</a>
      </div>
    </div>

    <div class="panel" id="bsPanel">
      <div class="grid" id="bsGpu"></div>
      <div class="grid" style="grid-template-columns:1fr;">
        <div class="g" id="bsCpu"></div>
      </div>
      <details>
        <summary>Processes</summary>
        <div class="plist" id="bsPs"></div>
      </details>
    </div>
  </div>
</div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const t = params.get('t') || '';
  const vb=document.getElementById('voicesBtn');
  if(vb) vb.href = '/voices?t='+encodeURIComponent(t);
  // debug: prove JS is running
  
  const bs = document.getElementById('bottomSheet');
  const btn = document.getElementById('bsToggle');

  function clampPct(x){
    if(x===null || x===undefined || Number.isNaN(x)) return 0;
    return Math.max(0, Math.min(100, x));
  }
  function klassForPct(p){
    if(p >= 85) return 'red';
    if(p >= 60) return 'amber';
    return 'green';
  }
  function metricRow(label, pct, cls, valueText){
    return `
      <div class="metric">
        <div class="label">${label}</div>
        <div class="ibar"><div class="ifill ${cls}" style="width:${pct}%"></div></div>
        <div class="val">${valueText}</div>
      </div>
    `;
  }

  function toggle(open){
    const isOpen = (open !== undefined) ? open : !bs.classList.contains('open');
    bs.classList.toggle('open', isOpen);
    btn.textContent = isOpen ? 'Hide' : 'Show';
    try{ localStorage.setItem('bsOpen', isOpen ? '1':'0'); }catch(e){}
  }

  btn.addEventListener('click', (e)=>{ e.preventDefault(); toggle(); });
  bs.querySelector('.handle').addEventListener('click', ()=>toggle());

  try{
    const saved = localStorage.getItem('bsOpen');
    if(saved==='1') toggle(true);
  }catch(e){}

  async function refresh(){
    const r = await fetch('/api/stats?t='+encodeURIComponent(t));
    if(!r.ok) return;
    const j = await r.json();
    if(!j.ok) return;

    // Mini line
    const mini = document.getElementById('bsMini');
    const cpuPct = j.cpu && (j.cpu.cpu_pct ?? null);
    const g0 = (j.gpu && j.gpu.length) ? j.gpu[0] : null;
    const gtxt = g0 ? `GPU0 ${Math.round(g0.util||0)}%` : 'GPU n/a';
    mini.textContent = `CPU ${cpuPct===null?'-':cpuPct}% • ${gtxt}`;

    // GPU cards
    const ge = document.getElementById('bsGpu');
    if(!j.gpu){ ge.innerHTML = '<div class="muted">(no GPU data)</div>'; }
    else {
      ge.innerHTML = '';
      for(const g of j.gpu){
        const util = clampPct(g.util);
        const vram = g.mem_total ? clampPct((g.mem_used/g.mem_total)*100.0) : 0;
        const gdiv = document.createElement('div');
        gdiv.className='g';
        gdiv.innerHTML = `
          <div class="ghead"><div class="gt">GPU ${g.index}</div><div class="gsub">${Math.round(g.power||0)}W • ${Math.round(g.temp||0)}C</div></div>
          ${metricRow('Util', util, klassForPct(util), `${Math.round(util)}%`)}
          ${metricRow('VRAM', vram, klassForPct(vram), `${(g.mem_used||0).toFixed(1)}/${(g.mem_total||0).toFixed(0)} MiB`)}
        `;
        ge.appendChild(gdiv);
      }
    }

    // CPU
    const ce = document.getElementById('bsCpu');
    if(!j.cpu){ ce.innerHTML = '<span class="muted">(no CPU data)</span>'; }
    else {
      const mem = j.cpu.mem_gb || {};
      ce.innerHTML = `
        <div class="ghead"><div class="gt">CPU</div><div class="gsub">RAM ${(mem.used??'-')} / ${(mem.total??'-')} GB</div></div>
        ${metricRow('CPU', clampPct(j.cpu.cpu_pct||0), klassForPct(j.cpu.cpu_pct||0), `${j.cpu.cpu_pct ?? '-'}%`)}
      `;
      document.getElementById('bsPs').textContent = (j.cpu.ps || []).join('\n');
    }
  }

  refresh();
  setInterval(refresh, 5000);
})();
</script>

</body>
</html>
