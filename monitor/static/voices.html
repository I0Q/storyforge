<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voices</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding:16px;}
    a{color:#0b63ce;}
    .top{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:12px;}
    .title{font-size:18px; font-weight:800; margin:0;}
    .muted{color:#666; font-size:12px;}

    .tabs{display:flex; gap:8px; margin:10px 0 14px;}
    .tab{padding:8px 10px; border:1px solid #d1d5db; border-radius:999px; font-weight:800; font-size:13px; text-decoration:none; color:#0b63ce; background:#fff;}
    .tab.active{background:#0b63ce; color:#fff; border-color:#0b63ce;}
    .tab.disabled{opacity:.45; pointer-events:none;}

    .card{border:1px solid #ddd; border-radius:14px; padding:12px; margin:12px 0;}
    .row{display:flex; justify-content:space-between; align-items:flex-start; gap:12px;}
    .left{flex:1; min-width:0;}
    .right{display:flex; gap:8px; align-items:center;}

    .swatch{width:44px; height:44px; border-radius:12px; border:1px solid #e5e7eb; display:flex; align-items:center; justify-content:center; font-weight:900; color:#111;}
    .name{font-weight:900; font-size:16px; margin:0;}
    .meta{font-size:12px; color:#666; margin-top:2px;}

    .btn{display:inline-block; padding:8px 10px; border-radius:999px; border:1px solid #d1d5db; text-decoration:none; font-weight:800; font-size:12px; color:#0b63ce; background:#fff;}
    .btn.primary{background:#0b63ce; color:#fff; border-color:#0b63ce;}

    .stars{display:flex; gap:4px; align-items:center;}
    .star{font-size:18px; line-height:1; cursor:pointer; user-select:none;}
    .star.on{color:#f59e0b;}
    .star.off{color:#d1d5db;}

    audio{width:100%; margin-top:10px;}
  </style>
</head>
<body>
  <div class="top">
    <div>
      <a id="back" href="#">Back</a>
      <h1 class="title">Voices</h1>
      <div class="muted">Tap Play to hear each voice introduce itself. Rate with stars.</div>
    </div>
  </div>

  <div class="tabs">
    <a id="tabT" class="tab active" href="#">Tortoise</a>
    <a class="tab disabled" href="#">(more soon)</a>
  </div>

  <div id="list">Loadingâ€¦</div>

<script>
const params = new URLSearchParams(location.search);
const t = params.get('t') || '';
const engine = params.get('engine') || 'tortoise';

document.getElementById('back').href = '/?t='+encodeURIComponent(t);
document.getElementById('tabT').href = '/voices?engine=tortoise&t='+encodeURIComponent(t);

function esc(s){
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function swatchBg(color){
  // simple mapping; fallback gray
  const m = {
    Ruby: '#fecaca',
    Onyx: '#111827',
    Slate: '#e5e7eb',
    Sapphire: '#bfdbfe',
  };
  return m[color] || '#f3f4f6';
}

function swatchFg(color){
  return (color==='Onyx') ? '#fff' : '#111';
}

async function setRating(id, rating){
  const url = `/api/voice/rate?engine=${encodeURIComponent(engine)}&id=${encodeURIComponent(id)}&rating=${encodeURIComponent(rating)}&t=${encodeURIComponent(t)}`;
  const r = await fetch(url);
  const j = await r.json();
  return j.ok;
}

function renderStars(id, cur){
  const wrap = document.createElement('div');
  wrap.className='stars';
  for(let i=1;i<=5;i++){
    const s=document.createElement('span');
    s.className='star ' + (i<=cur ? 'on':'off');
    s.textContent='â˜…';
    s.onclick = async ()=>{
      const ok = await setRating(id, i);
      if(ok){
        // rerender locally
        const parent = wrap.parentElement;
        parent.querySelectorAll('.star').forEach((el, idx)=>{
          el.className='star ' + ((idx+1)<=i ? 'on':'off');
        });
      }
    };
    wrap.appendChild(s);
  }
  return wrap;
}

async function load(){
  const r = await fetch(`/api/voices?engine=${encodeURIComponent(engine)}&t=${encodeURIComponent(t)}`);
  const j = await r.json();
  const el = document.getElementById('list');
  if(!j.ok){ el.textContent = 'Error'; return; }
  if(!j.voices || j.voices.length===0){ el.textContent='No voices.'; return; }

  el.innerHTML='';
  for(const v of j.voices){
    const card=document.createElement('div');
    card.className='card';

    const top=document.createElement('div');
    top.className='row';

    const left=document.createElement('div');
    left.className='left';
    left.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center;">
        <div class="swatch" style="background:${swatchBg(v.color)}; color:${swatchFg(v.color)};">${esc((v.color||'?').slice(0,1))}</div>
        <div>
          <div class="name">${esc(v.color || v.id)}</div>
          <div class="meta">${esc(v.role||'')} â€¢ ${esc(v.voice_name||'')}</div>
          <div class="muted" style="margin-top:4px;">${esc(v.notes||'')}</div>
        </div>
      </div>
    `;

    const right=document.createElement('div');
    right.className='right';

    const play=document.createElement('a');
    play.className='btn primary';
    play.href = '#';
    play.textContent = 'Play';
    play.onclick = (e)=>{
      e.preventDefault();
      const a = card.querySelector('audio');
      a.src = `/api/voice/demo/${encodeURIComponent(engine)}/${encodeURIComponent(v.id)}?t=${encodeURIComponent(t)}`;
      a.play();
    };

    right.appendChild(play);

    top.appendChild(left);
    top.appendChild(right);

    card.appendChild(top);
    card.appendChild(document.createElement('div')).appendChild(renderStars(v.id, v.rating||0));

    const audio=document.createElement('audio');
    audio.controls = true;
    audio.preload = 'none';
    card.appendChild(audio);

    el.appendChild(card);
  }
}

load();
</script>


<!-- Bottom sheet: system monitor -->
<style>
  .bs{position:fixed; left:0; right:0; bottom:0; z-index:9999; pointer-events:auto; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; will-change:transform;}
  .bs .handle{margin:0 auto; width:46px; height:5px; background:#d1d5db; border-radius:999px;}
  .bs .bar{background:rgba(255,255,255,.96); border-top:1px solid #e5e7eb; box-shadow:0 -10px 25px rgba(0,0,0,.08); padding:10px 14px calc(10px + env(safe-area-inset-bottom));}
  .bs .barTop{display:flex; justify-content:space-between; align-items:center; gap:10px;}
  .bs .title{font-weight:900; font-size:13px;}
  .bs .mini{font-size:12px; color:#666;}
  .bs .btn{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #d1d5db; text-decoration:none; font-weight:800; font-size:12px; color:#0b63ce; background:#fff;}
  .bs #bsToggle::before{content:"ðŸ“ˆ ";}
  .bs.open #bsToggle::before{content:"ðŸ“‰ ";}
  .btn .ico{display:inline-block; width:1.1em; text-align:center; margin-right:6px;}
  .bs .panel{display:none; padding-top:10px;}
  .bs.open .panel{display:block;}
  .bs .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-top:10px;}
  .bs .g{border:1px solid #ddd; border-radius:12px; padding:10px 12px; background:#fff;}
  .bs .ghead{display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px;}
  .bs .gt{font-weight:850;}
  .bs .gsub{font-size:12px; color:#666; white-space:nowrap;}
  .bs .metric{display:flex; align-items:center; gap:8px; margin:6px 0;}
  .bs .label{width:42px; font-size:12px; color:#666;}
  .bs .ibar{flex:1; height:8px; background:#f1f1f1; border-radius:999px; overflow:hidden;}
  .bs .ifill{height:8px; width:0%;}
  .bs .ifill.green{background:#1f9d55;}
  .bs .ifill.amber{background:#d97706;}
  .bs .ifill.red{background:#dc2626;}
  .bs .val{min-width:64px; text-align:right; font-variant-numeric:tabular-nums; font-size:12px; font-weight:700;}
  .bs details{border:1px solid #ddd; border-radius:12px; padding:10px 12px; margin-top:10px; background:#fff;}
  .bs summary{cursor:pointer; font-weight:750;}
  .bs .plist{margin-top:8px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:11px; color:#333; white-space:pre; overflow-x:auto;}
  html,body{height:100%;}
  body{padding-bottom:90px; -webkit-overflow-scrolling:touch;} /* room for bar */
</style>

<div id="bottomSheet" class="bs">
  <div class="bar">
    <div class="handle" aria-hidden="true"></div>
    <div class="barTop" style="margin-top:8px;">
      <div>
        <div class="title">System Monitor</div>
        <div class="mini" id="bsMini">Loadingâ€¦</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <a href="#" id="bsToggle" class="btn">Show</a>
      </div>
    </div>

    <div class="panel" id="bsPanel">
      <div class="grid" id="bsGpu"></div>
      <div class="grid" style="grid-template-columns:1fr;">
        <div class="g" id="bsCpu"></div>
      </div>
      <details>
        <summary>Processes</summary>
        <div class="plist" id="bsPs"></div>
      </details>
    </div>
  </div>
</div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const t = params.get('t') || '';
  const bs = document.getElementById('bottomSheet');
  const btn = document.getElementById('bsToggle');

  function clampPct(x){
    if(x===null || x===undefined || Number.isNaN(x)) return 0;
    return Math.max(0, Math.min(100, x));
  }
  function klassForPct(p){
    if(p >= 85) return 'red';
    if(p >= 60) return 'amber';
    return 'green';
  }
  function metricRow(label, pct, cls, valueText){
    return `
      <div class="metric">
        <div class="label">${label}</div>
        <div class="ibar"><div class="ifill ${cls}" style="width:${pct}%"></div></div>
        <div class="val">${valueText}</div>
      </div>
    `;
  }

  function toggle(open){
    const isOpen = (open !== undefined) ? open : !bs.classList.contains('open');
    bs.classList.toggle('open', isOpen);
    btn.textContent = isOpen ? 'Hide' : 'Show';
      }

  btn.addEventListener('click', (e)=>{ e.preventDefault(); toggle(); });
  bs.querySelector('.handle').addEventListener('click', ()=>toggle());

  async function refresh(){
    const r = await fetch('/api/stats?t='+encodeURIComponent(t));
    if(!r.ok) return;
    const j = await r.json();
    if(!j.ok) return;

    // Mini line
    const mini = document.getElementById('bsMini');
    const cpuPct = j.cpu && (j.cpu.cpu_pct ?? null);
    const g0 = (j.gpu && j.gpu.length) ? j.gpu[0] : null;
    const gtxt = g0 ? `GPU0 ${Math.round(g0.util||0)}%` : 'GPU n/a';
    mini.textContent = `CPU ${cpuPct===null?'-':cpuPct}% â€¢ ${gtxt}`;

    // GPU cards
    const ge = document.getElementById('bsGpu');
    if(!j.gpu){ ge.innerHTML = '<div class="muted">(no GPU data)</div>'; }
    else {
      ge.innerHTML = '';
      for(const g of j.gpu){
        const util = clampPct(g.util);
        const vram = g.mem_total ? clampPct((g.mem_used/g.mem_total)*100.0) : 0;
        const gdiv = document.createElement('div');
        gdiv.className='g';
        gdiv.innerHTML = `
          <div class="ghead"><div class="gt">GPU ${g.index}</div><div class="gsub">${Math.round(g.power||0)}W â€¢ ${Math.round(g.temp||0)}C</div></div>
          ${metricRow('Util', util, klassForPct(util), `${Math.round(util)}%`)}
          ${metricRow('VRAM', vram, klassForPct(vram), `${(g.mem_used||0).toFixed(1)}/${(g.mem_total||0).toFixed(0)} MiB`)}
        `;
        ge.appendChild(gdiv);
      }
    }

    // CPU
    const ce = document.getElementById('bsCpu');
    if(!j.cpu){ ce.innerHTML = '<span class="muted">(no CPU data)</span>'; }
    else {
      const mem = j.cpu.mem_gb || {};
      ce.innerHTML = `
        <div class="ghead"><div class="gt">CPU</div><div class="gsub">RAM ${(mem.used??'-')} / ${(mem.total??'-')} GB</div></div>
        ${metricRow('CPU', clampPct(j.cpu.cpu_pct||0), klassForPct(j.cpu.cpu_pct||0), `${j.cpu.cpu_pct ?? '-'}%`)}
      `;
      document.getElementById('bsPs').textContent = (j.cpu.ps || []).join('\n');
    }
  }

  refresh();
  setInterval(refresh, 5000);
})();
</script>

</body>
</html>
